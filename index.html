<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mapa da Campanha</title>

  <!-- Leaflet (mapa) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    header {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title { font-size: 18px; font-weight: 700; }
    .meta { font-size: 12px; color:#666; }
    #map { height: calc(100vh - 60px); width: 100%; }
    .badge {
      font-size: 12px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fafafa;
      display:inline-block;
    }
  </style>
</head>

<body>
  <header>
    <div>
      <div class="title" id="campanhaTitulo">Mapa da Campanha</div>
      <div class="meta" id="campanhaMeta">Carregando pontos…</div>
    </div>
    <div class="badge" id="contador">0 marcadores</div>
  </header>

  <div id="map"></div>

  <script>
    // Lê campanha.json do mesmo repositório/pasta
    const CAMPANHA_JSON = "campanha.json";

    // Ajustes padrão (caso o fitBounds não encontre nada)
    const DEFAULT_CENTER = [-23.55052, -46.633308]; // SP (fallback)
    const DEFAULT_ZOOM = 11;

    function safeText(v) {
      return (v === null || v === undefined) ? "" : String(v);
    }

    function pickLatLng(p) {
      // aceita chaves comuns: lat/lng, latitude/longitude
      const lat = (p.lat ?? p.latitude);
      const lng = (p.lng ?? p.lon ?? p.longitude);
      if (lat === null || lat === undefined || lng === null || lng === undefined) return null;

      const latN = typeof lat === "string" ? parseFloat(lat.replace(",", ".")) : Number(lat);
      const lngN = typeof lng === "string" ? parseFloat(lng.replace(",", ".")) : Number(lng);
      if (!Number.isFinite(latN) || !Number.isFinite(lngN)) return null;
      return [latN, lngN];
    }

    async function main() {
      // cria mapa
      const map = L.map("map", { zoomControl: true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);

      // tiles (OpenStreetMap)
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      let data;
      try {
        const res = await fetch(CAMPANHA_JSON, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status} ao abrir ${CAMPANHA_JSON}`);
        data = await res.json();
      } catch (err) {
        document.getElementById("campanhaMeta").textContent =
          "Erro ao carregar campanha.json. Verifique se ele está no repositório e público.";
        console.error(err);
        return;
      }

      // tenta identificar pontos em formatos diferentes:
      // - { pontos: [...] }
      // - { paradas: [...] }
      // - { stops: [...] }
      // - ou array direto: [...]
      const pontos =
        Array.isArray(data) ? data :
        (data.pontos ?? data.paradas ?? data.stops ?? []);

      const nomeCampanha = data.nome ?? data.campanha ?? data.titulo ?? "Mapa da Campanha";
      document.getElementById("campanhaTitulo").textContent = safeText(nomeCampanha);

      let countOk = 0;
      const bounds = [];

      for (const p of pontos) {
        const ll = pickLatLng(p);
        if (!ll) continue;

        const label = safeText(p.nome ?? p.endereco ?? p.address ?? p.label ?? "Parada");
        const bairro = safeText(p.bairro ?? p.neighborhood ?? "");
        const cidade = safeText(p.cidade ?? p.city ?? "");
        const uf = safeText(p.uf ?? p.estado ?? p.state ?? "");

        const popupHtml = `
          <div style="font-family: Arial, sans-serif; font-size: 13px;">
            <div style="font-weight:700; margin-bottom:4px;">${label}</div>
            ${bairro ? `<div><b>Bairro:</b> ${bairro}</div>` : ""}
            ${(cidade || uf) ? `<div><b>Cidade:</b> ${cidade}${uf ? " - " + uf : ""}</div>` : ""}
            <div style="color:#666; margin-top:6px;">${ll[0].toFixed(6)}, ${ll[1].toFixed(6)}</div>
          </div>
        `;

        L.marker(ll).addTo(map).bindPopup(popupHtml);
        bounds.push(ll);
        countOk++;
      }

      document.getElementById("contador").textContent = `${countOk} marcadores`;
      document.getElementById("campanhaMeta").textContent =
        countOk > 0 ? "Clique nos marcadores para ver detalhes." : "Nenhum ponto com lat/long encontrado no JSON.";

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    main();
  </script>
</body>
</html>
